package com.mtkreader.views.fragments

import android.content.Intent
import android.os.Bundle
import android.util.Base64
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.webkit.WebViewClient
import com.mtkreader.R
import com.mtkreader.commons.base.BaseMVPFragment
import com.mtkreader.contracts.ParamsWriteContract
import com.mtkreader.presenters.ParamsWritePresenter
import com.mtkreader.utils.SharedPrefsUtils
import kotlinx.android.synthetic.main.fragment_file_pick.*

class ParamsWriteView : BaseMVPFragment<ParamsWriteContract.Presenter>(), ParamsWriteContract.View {

    companion object {
        private const val FILE_PICK_CODE = 1
    }

    private val fileLines = mutableListOf<String>()

    override fun onCreateView(
        inflater: LayoutInflater,
        container: ViewGroup?,
        savedInstanceState: Bundle?
    ): View? {
        return inflater.inflate(R.layout.fragment_file_pick, container, false)
    }

    override fun onActivityCreated(savedInstanceState: Bundle?) {
        super.onActivityCreated(savedInstanceState)
        initPresenter()
        initViews()
    }

    private fun initPresenter() {
        presenter = ParamsWritePresenter(this)
    }

    private fun initViews() {
        btn_pick_file.setOnClickListener {
            Intent(Intent.ACTION_GET_CONTENT).apply {
                type = "application/octet-stream*"

                addCategory(Intent.CATEGORY_DEFAULT)
            }.also {
                startActivityForResult(it, FILE_PICK_CODE)
            }
        }

        // val lastFileData = SharedPrefsUtils.getLastFileRead(requireContext())
        val lastFileData = "//Programiranje tst2.mtk\n" +
                "\n" +
                "UPMTK-2-t-8-V-98\n" +
                "\n" +
                "#FR04,#RA04#UF004F#DP0082\n" +
                "\n" +
                "#Comment tst2\n" +
                "\n" +
                "0180(00000000)\n" +
                "8080(00000E8B003972000E8B80397200645900807700807780645900000001010507070800004300000000070000420000000016000080000000000514088000000080000000800000008000000080000000010100C821FF1FFF,0000,0000)\n" +
                "8180(8000800080000800800080800040004000040040004080004000400002004000200080008000800080008000000000000000000000000000)\n" +
                "8280(E3E0008000800000000200000000000000000000008040404040A4)\n" +
                "9080(800010000010002C8000100000100000400020000020002B4000200000200000)\n" +
                "9180(200040000040002A200040000040000010008000000000111000800000000000)\n" +
                "9280(0801000FF00000240801000FF0000000000000000000000C0FF0000000000000)\n" +
                "9380(000FF00000000014000FF0000000000000000FE00000001B00000FE000000000)\n" +
                "9480(1860000000F0002C1860200000F00001082000000F000028082020000F000002082000007000002C0820200070100003)\n" +
                "9580(080000038000002C08202003803000040800003C0000002C0820203C00700005)\n" +
                "9680(080001C00000002C082021C000F0000908200E000000002C08202E0003F0000A082050000000002C082070000FF00040)\n" +
                "9880(300000018000002130000001800000000C070080F00000240C070080F0000000)\n" +
                "9980(0701C0E00F0000280701C0E00F00000000C0301800F0002C00C0301800F0000000600E038000002100600E0380000000)\n" +
                "9A80(000C0380F0000024000C0380F0000000000380700F000028000380700F0000000000700F000000200000700F00000000)\n" +
                "9B80(0000000000000000000000000000000000000000000000000000000000000000)\n" +
                "9C80(000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000)\n" +
                "1080(F0007F21C2942D03C03FC4EC5281E0800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "1180(8000AA1A41E0800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "1280(40005580080003C078800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "1380(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "1480(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "1580(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "1680(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "1780(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "1880(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "1980(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "1A80(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "1B80(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "1C80(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "1D80(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "1E80(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "1F80(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "2080(F0007F21C2942D03C03FC4EC5281E0800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "2180(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "2280(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "2380(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "2480(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "2580(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "2680(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "2780(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "2880(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "2980(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "2A80(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "2B80(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "2C80(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "2D80(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "2E80(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "2F80(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "3080(C0007F03C16830C3C0800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "3180(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "3280(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "3380(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "3480(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "3580(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "3680(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "3780(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "3880(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "3980(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "3A80(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "3B80(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "3C80(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "3D80(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "3E80(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "3F80(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "4080(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "4180(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "4280(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "4380(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "4480(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "4580(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "4680(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "4780(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "4880(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "4980(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "4A80(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "4B80(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "4C80(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "4D80(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "4E80(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "4F80(000000800800800800800800800800800800800800800800800800800800800800800800800800800800800800FFFFFFFFFFFFFFFFFFFFFFFF)\n" +
                "7080(000300)\n" +
                "7280(000000006E)\n" +
                "7380(00000000000000000000000000000000000000000000000000000000000000000000)\n" +
                "5080(290000B4041EB0001C20A000000000000000000048001CD400452600000028000E8B000000003972)\n" +
                "5180(8100000E11000F3C0007080000001C208300001C21001D4C0007080101000E108500002A31002B5C0007080202001C2089000038400038400000000501000000)\n" +
                "5280(01000E10010101001C20028201002A300303010038400485)\n" +
                "5380(004000000000003C104000000000007810200000000000B400200000000000F0)\n" +
                "0380(33333333DC68C0020F0F0F0FE002E00233333333C002C002FFFFFFFF00010001)\n" +
                "C080(1A1A0A4000000D310C8003B101010400000400CF019E0258019C028C033F002C009C00C800E300EF010A010A025800E6002CF5E0)\n" +
                "A080(FFFF0100000000000000000000000000)\n" +
                "G6(0000000000)\n" +
                "G7(616E7465000000006100000000000000747374320000000000000000000000000000)\n"
        if (lastFileData != null) {
            presenter.extractFileData(lastFileData.trimAndSplit())
            btn_last_file.visibility = View.VISIBLE
            btn_last_file.setOnClickListener {
                presenter.extractFileData(lastFileData.trimAndSplit())
            }
        }
    }

    override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
        super.onActivityResult(requestCode, resultCode, data)
        if (requestCode == FILE_PICK_CODE) {
            val fileUri = data?.data
            if (fileUri != null) {
                val input = requireContext().contentResolver.openInputStream(fileUri)
                val fileContent = input?.bufferedReader().use { it?.readText() }
                if (fileContent != null) {
                    fileLines.clear()
                    fileLines.addAll(fileContent.trimAndSplit())
                    if (fileLines.isNotEmpty()) {
                        SharedPrefsUtils.saveLastFileRead(requireContext(), fileContent)
                        presenter.extractFileData(fileLines)
                    }
                }
            } else toast(getString(R.string.no_file_picked))
        }
    }

    override fun onError(throwable: Throwable) {

    }

    override fun onHtml(html: String) {
        webView.apply {
            settings.javaScriptEnabled = true
            webViewClient = WebViewClient()
            /*
            settings.loadWithOverviewMode = true
            settings.useWideViewPort = true
            settings.setSupportZoom(true)
            settings.builtInZoomControls = true
            settings.displayZoomControls = false
            settings.loadWithOverviewMode = true
            settings.useWideViewPort = true
            settings.layoutAlgorithm = WebSettings.LayoutAlgorithm.NORMAL*/
            //settings.
        }
        val encodedHtml: String = Base64.encodeToString(html.toByteArray(Charsets.UTF_8), Base64.NO_PADDING)
        webView.loadData(encodedHtml, "text/html", "base64")
    }

    private fun String.trimAndSplit(): List<String> {
        return trim().lines().filter { it.isNotBlank() }
    }
}